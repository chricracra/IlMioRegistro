<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>NeoRegister</title>
        
        <link rel="manifest" href="manifest.json">
        
        <link rel="apple-touch-icon" href="images/icon-192.png">
        
        <link rel="icon" href="images/icon-192.png" type="image/png">
        <link rel="shortcut icon" href="images/icon-192.png" type="image/png">
        
        <meta name="theme-color" content="#0f172a">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

        <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <style>
        /* --- STILI BASE --- */
        :root {
            --bg-color: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-color: #6366f1;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --gold: #fbbf24;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 40%), radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.15) 0%, transparent 40%);
            color: var(--text-main);
            margin: 0; padding: 0; min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            transition: background-color 0.3s ease, color 0.3s ease;
            overscroll-behavior: none;
        }

        #app-screen, #detail-screen, #settings-screen { display: none; width: 100%; padding: 20px; box-sizing: border-box; flex-direction: column; align-items: center; animation: fadeIn 0.5s ease; }
        
        /* LOGIN SCREEN */
        #login-screen {
            width: 100%; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            position: absolute; top: 0; left: 0; z-index: 100;
            background-color: var(--bg-color);
            color: var(--text-main);
            transition: background-color 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- COOKIE BANNER --- */
        #cookie-banner {
            display: none;
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(15, 23, 42, 0.95);
            border-top: 1px solid var(--accent-color);
            padding: 20px; box-sizing: border-box;
            z-index: 999; text-align: center;
            backdrop-filter: blur(10px);
            animation: slideUp 0.5s ease;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* --- SETUP MODAL --- */
        #setup-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .setup-box {
            background: #1e293b; border: 1px solid var(--accent-color); padding: 30px;
            border-radius: 20px; width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.3);
        }

        .container { width: 100%; max-width: 1200px; display: grid; grid-template-columns: 1fr 320px; gap: 20px; }
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; } }

        .card {
            background: var(--glass-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); margin-bottom: 20px; transition: transform 0.2s ease;
        }

        input, select {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            color: white; padding: 12px; border-radius: 8px; margin-bottom: 10px;
            box-sizing: border-box; outline: none; transition: 0.3s;
            font-family: 'Outfit', sans-serif; font-size: 16px; cursor: pointer;
        }
        input:focus, select:focus { border-color: var(--accent-color); box-shadow: 0 0 10px rgba(99, 102, 241, 0.2); }
        option { background: #1e293b; color: white; padding: 10px; }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 16px; }
        .btn-primary { background: linear-gradient(45deg, var(--accent-color), #ec4899); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(236, 72, 153, 0.4); }
        .btn-outline { background: transparent; border: 1px solid var(--accent-color); margin-right: 10px; }

        /* Social & Divider */
        .btn-social {
            width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;
            background: white; color: #1e293b; border: 1px solid #cbd5e1; padding: 12px; border-radius: 8px;
            cursor: pointer; transition: 0.3s; font-weight: 600; margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; font-size: 16px;
        }
        .btn-social:hover { background: #f8fafc; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: #94a3b8; }
        
        .divider { display: flex; align-items: center; text-align: center; color: var(--text-muted); font-size: 0.8rem; margin: 20px 0; }
        .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid var(--glass-border); }
        .divider span { padding: 0 10px; }

        .auth-switch { margin-top: 15px; color: var(--text-muted); font-size: 0.9rem; cursor: pointer; text-decoration: underline; }
        
        /* Campo Nome Nascosto */
        #register-name-field { overflow: hidden; transition: max-height 0.4s ease-in-out; max-height: 0; }
        .show-name-field { max-height: 60px !important; margin-bottom: 10px; }

        .dropdown { position: relative; display: inline-block; }
        .menu-btn { background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: white; padding: 10px 20px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .dropdown-content { display: none; position: absolute; right: 0; top: 50px; background: #1e293b; min-width: 200px; box-shadow: 0 8px 16px rgba(0,0,0,0.5); border-radius: 12px; border: 1px solid var(--glass-border); z-index: 10; overflow: hidden; }
        .dropdown-content a { color: var(--text-main); padding: 12px 16px; text-decoration: none; display: block; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .dropdown-content a:hover { background-color: rgba(255,255,255,0.05); }
        .dropdown-danger:hover { background-color: rgba(239, 68, 68, 0.2) !important; color: var(--danger) !important; }
        .show { display: block; }

        .subject-card { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border-left: 4px solid var(--accent-color); margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .subject-card:hover { background: rgba(255,255,255,0.08); transform: translateX(5px); }
        
        .grade-item-detailed { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; display: flex; align-items: center; gap: 10px; margin-bottom: 8px; border: 1px solid transparent; }
        .grade-val { font-size: 1.2rem; font-weight: bold; width: 50px; text-align: center; }
        .grade-good { color: var(--success); } .grade-bad { color: var(--danger); }
        .grade-weight { font-size: 0.75rem; color: var(--text-muted); background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; }
        .delete-single-btn { margin-left: auto; color: #64748b; cursor: pointer; padding: 5px; }
        .delete-single-btn:hover { color: var(--danger); }

        .strategy-box { background: rgba(0,0,0,0.2); border: 1px solid; padding: 20px; border-radius: 12px; margin-bottom: 20px; position: relative; overflow: hidden; }
        .strategy-safe { border-color: var(--success); color: #86efac; background: rgba(16, 185, 129, 0.1); }
        .strategy-danger { border-color: var(--danger); color: #fca5a5; background: rgba(239, 68, 68, 0.1); }
        
        /* --- PATH STYLES --- */
        .path-container { display: flex; flex-direction: column; align-items: center; margin-top: 15px; }
        .path-steps { display: flex; align-items: center; gap: 5px; overflow-x: auto; max-width: 100%; padding: 10px 0; }
        .path-step-card {
            background: var(--bg-color); border: 1px solid var(--glass-border);
            padding: 10px; border-radius: 10px; min-width: 60px; text-align: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .path-step-val { font-size: 1.3rem; font-weight: bold; }
        .path-arrow { color: var(--text-muted); font-size: 0.8rem; margin: 0 5px; }
        
        /* STILI ICONE STEP */
        .path-icon { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 5px; opacity: 0.8; }
        .step-hard .path-icon { color: var(--warning); }
        .step-easy .path-icon { color: var(--success); }
        .step-extreme .path-icon { color: var(--danger); }
        
        .step-hard { border-color: var(--warning); color: var(--warning); }
        .step-easy { border-color: var(--success); color: var(--success); }
        .step-extreme { border-color: var(--danger); color: var(--danger); }

        .strategy-divider { display: flex; align-items: center; margin: 20px 0; color: var(--text-muted); font-size: 0.8rem; letter-spacing: 1px; }
        .strategy-divider::before, .strategy-divider::after { content: ''; flex: 1; border-bottom: 1px solid var(--glass-border); }
        .strategy-divider span { padding: 0 10px; }

        .oneshot-card { background: linear-gradient(45deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1)); border: 1px solid rgba(251, 191, 36, 0.3); padding: 15px; border-radius: 10px; text-align: center; color: var(--gold); }
        .oneshot-val { font-size: 2rem; font-weight: bold; margin: 5px 0; }
        .safety-card { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); padding: 15px; border-radius: 10px; text-align: center; color: var(--success); margin-top: 10px; }
        .safety-val { font-size: 2rem; font-weight: bold; margin: 5px 0; }

        .coach-card { background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01)); border: 1px solid var(--accent-color); position: relative; overflow: hidden; min-height: 100px; }
        .coach-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .coach-icon { font-size: 1.5rem; color: #38bdf8; animation: pulse 2s infinite; }
        .coach-text { font-size: 0.95rem; line-height: 1.5; color: #e2e8f0; font-style: italic; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; }
        .stat-value { font-size: 2rem; font-weight: bold; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        #loader { display: none; margin-top: 10px; color: var(--accent-color); }
        
        /* VOTE SELECTOR */
        .vote-selector-wrapper { display: flex; gap: 10px; align-items: stretch; margin-bottom: 10px; flex-wrap: wrap; }
        .vote-stepper { display: flex; align-items: center; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 8px; overflow: hidden; flex: 1; min-width: 120px; }
        .btn-step { background: none; border: none; color: white; padding: 12px; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
        .btn-step:hover { background: rgba(255,255,255,0.1); }
        .vote-display { flex-grow: 1; text-align: center; font-size: 1.5rem; font-weight: bold; }
        .vote-modifiers { display: flex; gap: 5px; flex: 2; min-width: 200px; }
        .btn-mod { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); color: white; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; padding: 10px 0; font-size: 14px; }
        .btn-mod:hover { border-color: var(--accent-color); }
        .btn-mod.active { background: var(--accent-color); border-color: var(--accent-color); box-shadow: 0 0 10px rgba(99, 102, 241, 0.4); }
        .btn-mod:disabled { opacity: 0.3; cursor: not-allowed; border-color: transparent; }

        /* --- TEMA CHIARO (Light Mode) --- */
        body.light-mode {
            --bg-color: #e2e8f0;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 1);
            --text-main: #0f172a;
            --text-muted: #475569;
            background-image: radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.2) 0%, transparent 40%), radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.2) 0%, transparent 40%);
        }

        /* FIX LOGIN CHIARO (Forzato) */
        body.light-mode #login-screen {
            background-color: #e2e8f0 !important;
            color: #0f172a !important;
        }

        body.light-mode .card { box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); }
        body.light-mode .dropdown-content { background: white !important; border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        body.light-mode .dropdown-content a { color: #0f172a; }
        body.light-mode .dropdown-content a:hover { background-color: #f1f5f9; }
        body.light-mode .menu-btn { background: rgba(255,255,255,0.5); color: #0f172a; border-color: rgba(0,0,0,0.1); }
        body.light-mode .coach-text { color: #334155 !important; font-weight: 500; }
        body.light-mode #cookie-banner { background: rgba(255, 255, 255, 0.95); border-top: 1px solid #cbd5e1; color: #0f172a; }

        body.light-mode input, body.light-mode select { background: #f1f5f9 !important; color: #0f172a !important; border: 1px solid #cbd5e1 !important; }
        body.light-mode input:focus, body.light-mode select:focus { background: #fff !important; border-color: var(--accent-color) !important; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
        body.light-mode option { background: white; color: black; }

        body.light-mode .vote-stepper { background: #f1f5f9; border-color: #cbd5e1; color: #0f172a; }
        body.light-mode .btn-step { color: #0f172a; }
        body.light-mode .btn-step:hover { background: rgba(0,0,0,0.05); }
        body.light-mode .btn-mod { background: #f1f5f9; border-color: #cbd5e1; color: #0f172a; }
        body.light-mode .btn-mod:hover { border-color: var(--accent-color); }
        body.light-mode .btn-mod.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        body.light-mode .btn-mod:disabled { opacity: 0.3; background: #e2e8f0; }

        body.light-mode .subject-card,
        body.light-mode .grade-item-detailed { background: white !important; border: 1px solid #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        body.light-mode .subject-card:hover { background: #f8fafc !important; }

        body.light-mode .btn[style*="--danger"] { color: #ef4444 !important; border-color: #ef4444 !important; }
        body.light-mode .btn[style*="--danger"]:hover { background: #ef4444 !important; color: white !important; }

        body.light-mode .btn-outline:not([style*="--danger"]) { border-color: var(--accent-color) !important; color: var(--accent-color) !important; }
        body.light-mode .btn-outline:not([style*="--danger"]):hover { background: var(--accent-color) !important; color: white !important; }
        body.light-mode .btn[style*="background:none"], body.light-mode .btn[style*="background: none"] { color: #0f172a !important; }

        /* FIX COLORI STRATEGIA LIGHT MODE (Nuovi e puliti) */
        /* Sovrascrive il box grigio generico */
        body.light-mode .strategy-box {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            color: #0f172a !important;
        }

        body.light-mode .strategy-safe {
            color: #15803d !important;
            background: #ffffff !important;
            border: 1px solid #22c55e !important;
        }
        body.light-mode .strategy-danger {
            color: #b91c1c !important;
            background: #ffffff !important;
            border: 1px solid #ef4444 !important;
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.1);
        }
        
        body.light-mode .safety-card { color: #15803d !important; border-color: #15803d !important; background: rgba(22, 163, 74, 0.1); }
        body.light-mode .oneshot-card { color: #c2410c !important; border-color: #f97316 !important; background: rgba(255, 237, 213, 0.5); }
        
        /* PATH STYLE LIGHT */
        body.light-mode .path-step-card {
            background: white !important;
            border: 1px solid #cbd5e1 !important;
            color: #0f172a;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05) !important;
        }
        body.light-mode .path-arrow { color: #94a3b8; }
        
        /* Select dentro box strategia light mode */
        body.light-mode #recovery-count { color: #0f172a !important; border-bottom: 1px solid #cbd5e1 !important; }
        body.light-mode #recovery-count option { background: white; color: black; }

        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(24px); }
    </style>
</head>
<body>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
            }
        })();
    </script>

    <div id="login-screen">
        <div class="card" style="width: 350px; text-align: center;">
            <h1>NeoRegister <i class="fa-solid fa-graduation-cap"></i></h1>
            <p id="auth-title" style="color: inherit; margin-bottom: 20px;">Accedi al tuo account</p>
            
            <button class="btn-social" onclick="loginWithGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" style="width: 20px; height: 20px;">
                Accedi con Google
            </button>

            <div class="divider"><span>OPPURE CON EMAIL</span></div>

            <div id="register-name-field">
                <input type="text" id="name-input" placeholder="Il tuo Nome (es. Giulia)" style="border-color: var(--accent-color);">
            </div>

            <input type="email" id="email-input" placeholder="Email">
            <input type="password" id="password-input" placeholder="Password">
            
            <button id="auth-btn" class="btn btn-primary" onclick="handleAuth()">Accedi</button>
            <div class="auth-switch" onclick="toggleAuthMode()">Non hai un account? Registrati</div>
            <div id="loader"><i class="fa-solid fa-spinner fa-spin"></i> Attendi...</div>
            <p id="error-msg" style="color: var(--danger); font-size: 0.8rem; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="cookie-banner">
        <div style="max-width: 600px; margin: 0 auto;">
            <p style="margin-bottom: 15px; font-size: 0.95rem;">
                <i class="fa-solid fa-cookie-bite" style="color: var(--gold)"></i>
                Questo sito usa un salvataggio locale per ricordare la tua preferenza sul <strong>Tema (Chiaro/Scuro)</strong> sul questo dispositivo. Vuoi accettare?
            </p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn btn-outline" style="width: auto; padding: 8px 20px;" onclick="handleCookieConsent(false)">Rifiuta</button>
                <button class="btn btn-primary" style="width: auto; padding: 8px 20px;" onclick="handleCookieConsent(true)">Accetta</button>
            </div>
        </div>
    </div>

    <div id="setup-modal">
        <div class="card setup-box">
            <h2>ðŸ‘‹ Ciao!</h2>
            <p style="color:var(--text-muted)">Per parlarti come si deve, ho bisogno di sapere come preferisci che mi rivolga a te.</p>
            <select id="setup-pronoun" style="margin-top:20px; border-color:var(--accent-color);">
                <option value="m" selected>Maschile (Bravo, Sei stato...)</option>
                <option value="f">Femminile (Brava, Sei stata...)</option>
                <option value="n">Neutro (Grande, Ottimo lavoro...)</option>
            </select>
            <button class="btn btn-primary" style="margin-top:20px;" onclick="saveSetup()">Iniziamo!</button>
        </div>
    </div>

    <div id="app-screen">
        <header style="width: 100%; max-width: 1200px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h1>Ciao, <span id="display-name" style="color:var(--accent-color)">Studente</span></h1>
                <p style="color: var(--text-muted)">I tuoi obiettivi sono a portata di mano</p>
            </div>
            <div class="dropdown">
                <button onclick="toggleMenu()" class="menu-btn"><i class="fa-solid fa-user-gear"></i> Account <i class="fa-solid fa-caret-down"></i></button>
                <div id="myDropdown" class="dropdown-content">
                    <a onclick="openSettings()"><i class="fa-solid fa-gear"></i> Impostazioni</a>
                    <a onclick="logoutUser()"><i class="fa-solid fa-right-from-bracket"></i> Esci</a>
                </div>
            </div>
        </header>

        <div class="container">
            <main>
                <div class="card stats-grid">
                    <div><div class="stat-value" id="global-average">0.0</div><small>Media Globale</small></div>
                    <div><div class="stat-value" id="count-subjects">0</div><small>Materie</small></div>
                    <div><div class="stat-value" id="count-grades">0</div><small>Voti Totali</small></div>
                </div>
                <div class="card"><div class="chart-container"><canvas id="gradeChart"></canvas></div></div>
                <div id="subjects-container"></div>
            </main>

            <aside>
                <div class="card coach-card">
                    <div class="coach-header">
                        <i class="fa-solid fa-brain coach-icon"></i><h3 style="margin:0; font-size:1.1rem; color:#38bdf8;">Mental Coach</h3>
                    </div>
                    <div id="coach-message" class="coach-text">Analisi motivazionale in corso...</div>
                </div>

                <div class="card">
                    <h3>Registra Voto</h3>
                    <select id="input-subject"><option value="">Caricamento...</option></select>
                    <label style="font-size:0.8rem; color:var(--text-muted);">Voto</label>
                    
                    <div class="vote-selector-wrapper">
                        <div class="vote-stepper">
                            <button class="btn-step" onclick="updateInt('dash', -1)">-</button>
                            <span id="dash-vote-val" class="vote-display">6</span>
                            <button class="btn-step" onclick="updateInt('dash', 1)">+</button>
                        </div>
                        <div class="vote-modifiers">
                            <button class="btn-mod active" id="dash-mod-none" onclick="setMod('dash', 'none')">Int</button>
                            <button class="btn-mod" id="dash-mod-plus" onclick="setMod('dash', 'plus')">+</button>
                            <button class="btn-mod" id="dash-mod-minus" onclick="setMod('dash', 'minus')">-</button>
                            <button class="btn-mod" id="dash-mod-half" onclick="setMod('dash', 'half')">Â½</button>
                        </div>
                    </div>

                    <label style="font-size:0.8rem; color:var(--text-muted);">Peso %</label>
                    <div style="display:flex; align-items:center; gap:5px; margin-bottom:15px;">
                        <input type="number" id="input-weight" value="100" min="0" max="100" style="margin-bottom:0;">
                        <span>%</span>
                    </div>
                    <button class="btn btn-primary" onclick="addGradeDB()">Salva Voto</button>
                </div>

                <div class="card">
                    <h3>Nuova Materia</h3>
                    <input type="text" id="new-subject-name" placeholder="Nome Materia">
                    <button class="btn btn-outline" onclick="addSubjectDB()">Crea</button>
                </div>
            </aside>
        </div>
    </div>

    <div id="detail-screen">
        <div style="width: 100%; max-width: 800px;">
            <button class="btn" style="width:auto; background:none; text-align:left; padding-left:0;" onclick="closeDetail()">
                <i class="fa-solid fa-arrow-left"></i> Torna alla Dashboard
            </button>
            <div class="card" style="margin-top:10px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h1 id="detail-title" style="margin:0;">Materia</h1>
                    <div>
                        <div id="detail-average" style="font-size: 2.5rem; font-weight:bold; text-align:right;">0.0</div>
                        <small style="color:var(--text-muted)">Media Ponderata</small>
                    </div>
                </div>
            </div>
            
            <div id="strategy-container"></div>
            
            <div class="card" style="border: 1px solid var(--accent-color);">
                <h3><i class="fa-solid fa-plus-circle"></i> Aggiungi Voto</h3>
                
                <div class="vote-selector-wrapper">
                    <div class="vote-stepper">
                        <button class="btn-step" onclick="updateInt('det', -1)">-</button>
                        <span id="det-vote-val" class="vote-display">6</span>
                        <button class="btn-step" onclick="updateInt('det', 1)">+</button>
                    </div>
                    <div class="vote-modifiers">
                        <button class="btn-mod active" id="det-mod-none" onclick="setMod('det', 'none')">Int</button>
                        <button class="btn-mod" id="det-mod-plus" onclick="setMod('det', 'plus')">+</button>
                        <button class="btn-mod" id="det-mod-minus" onclick="setMod('det', 'minus')">-</button>
                        <button class="btn-mod" id="det-mod-half" onclick="setMod('det', 'half')">Â½</button>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; align-items: center; justify-content: flex-end; margin-top:10px;">
                    <div style="display:flex; align-items:center; gap:5px; width: 100px;">
                        <input type="number" id="detail-input-weight" value="100" min="0" max="100" style="margin:0;">
                        <span>%</span>
                    </div>
                    <button class="btn btn-primary" style="width: auto;" onclick="addGradeFromDetail()">
                        <i class="fa-solid fa-save"></i> Salva
                    </button>
                </div>
            </div>

            <div class="card">
                <h3>Registro Voti</h3>
                <div id="detail-grades-list" style="display:flex; flex-direction:column; gap:5px;"></div>
                <br>
                <button class="btn btn-outline" style="border-color: var(--danger); color: var(--danger); width:auto;" onclick="deleteCurrentSubject()">
                    <i class="fa-solid fa-trash"></i> Elimina Materia
                </button>
            </div>
            <div class="card">
                <h3>Andamento</h3>
                <div class="chart-container" style="height: 200px;"><canvas id="detailChart"></canvas></div>
            </div>
        </div>
    </div>
    <div id="settings-screen">
        <div style="width: 100%; max-width: 800px;">
            <button class="btn" style="width:auto; background:none; text-align:left; padding-left:0;" onclick="closeSettings()">
                <i class="fa-solid fa-arrow-left"></i> Torna alla Dashboard
            </button>

            <div class="card" style="margin-top:10px;">
                <h1><i class="fa-solid fa-sliders"></i> Impostazioni</h1>
                <p style="color:var(--text-muted)">Gestisci il tuo account e le preferenze di NeoRegister.</p>
            </div>
            
            <div class="card">
                <h3>Valore dei simboli (+ / -)</h3>
                <p style="color:var(--text-muted); font-size:0.9rem;">Scegli quanto vale un "piÃ¹" o un "meno" sui voti.</p>
                <select id="grade-step-input" onchange="updateGradeStepDB()">
                    <option value="0.20">0.20 (Standard)</option>
                    <option value="0.25">0.25 (Quarti di punto)</option>
                    <option value="0.30">0.30 (Alto)</option>
                </select>
            </div>

            <div class="card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                <div>
                    <h3 style="margin:0;"><i class="fa-solid fa-moon"></i> Tema Scuro</h3>
                    <small style="color:var(--text-muted)">Disattiva per passare al tema chiaro</small>
                </div>
                <label class="switch">
                    <input type="checkbox" id="theme-switch" onchange="toggleThemeDB()" checked>
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="card" style="border: 1px solid var(--danger);">
                <h3 style="color: var(--danger);"><i class="fa-solid fa-triangle-exclamation"></i> Zona Pericolosa</h3>
                <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom: 20px;">
                    L'eliminazione dell'account Ã¨ irreversibile. Perderai tutti i voti e le materie salvate.
                </p>
                <button class="btn btn-outline" style="border-color: var(--danger); color: var(--danger);" onclick="deleteMyAccount()">
                    <i class="fa-solid fa-trash-can"></i> Elimina il mio Account
                </button>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, deleteUser, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CLASSE AI INTEGRATA ---
        class RecoveryAI {
            constructor(grades, userGradeStep) {
                this.grades = grades;
                this.step = userGradeStep;
                this.stats = this.analyzeHistory();
            }

            analyzeHistory() {
                if (!this.grades || this.grades.length === 0) {
                    return { max: 6, min: 6, avg: 6, trend: 'stable', volatility: 0, currentSum: 0, currentWeight: 0 };
                }
                let sum = 0, weightSum = 0, max = 0, min = 10, vals = [];
                this.grades.forEach(g => {
                    let val = (typeof g === 'number') ? g : g.val;
                    let weight = (g.weight !== undefined) ? g.weight : 100;
                    if (val > max) max = val;
                    if (val < min) min = val;
                    sum += val * (weight / 100);
                    weightSum += (weight / 100);
                    vals.push(val);
                });
                let trend = 'stable';
                if (vals.length >= 3) {
                    const last3 = vals.slice(-3);
                    const avgLast3 = last3.reduce((a, b) => a + b, 0) / 3;
                    const globalAvg = weightSum > 0 ? sum / weightSum : 0;
                    if (avgLast3 > globalAvg + 0.5) trend = 'rising';
                    else if (avgLast3 < globalAvg - 0.5) trend = 'falling';
                }
                return { max, min, avg: weightSum > 0 ? sum / weightSum : 0, currentSum: sum, currentWeight: weightSum, trend };
            }

            // --- CALCOLO PERCORSO CRESCENTE ---
            calculatePath(targetAvg, numGrades) {
                const N = parseInt(numGrades);
                const targetTotalScore = targetAvg * (this.stats.currentWeight + N);
                const neededTotalPoints = targetTotalScore - this.stats.currentSum;
                
                // Se servono troppi punti, impossibile
                if (neededTotalPoints / N > 10) {
                     return { impossible: true, neededAvg: (neededTotalPoints/N).toFixed(2), path: [] };
                }

                const validGrades = this.generateValidGradeScale();
                const avgNeeded = neededTotalPoints / N;

                // Se Ã¨ 1 solo voto, Ã¨ semplice
                if (N === 1) {
                    let found = validGrades.find(g => g.val >= avgNeeded);
                    if (!found) found = { val: avgNeeded, display: avgNeeded.toFixed(2), impossible:true };
                    return {
                        neededAvg: found.display,
                        numericVal: found.val,
                        difficulty: this.evaluateDifficulty(found.val),
                        path: [found], // Percorso di 1 step
                        message: this.generateAdvice(found.val, N, found.display, found.impossible)
                    };
                }

                // Generazione Percorso Crescente (Linear Progression)
                let path = [];
                let pointsRemaining = neededTotalPoints;
                
                for(let i=0; i<N; i++) {
                    let progressFactor = (i - (N-1)/2) * 0.5; // Slope factor (es. -0.5, 0, +0.5)
                    let targetVal = avgNeeded + progressFactor;
                    
                    // Se Ã¨ l'ultimo step, deve coprire ESATTAMENTE il rimanente
                    if (i === N - 1) {
                        targetVal = pointsRemaining;
                    }

                    // Trova il voto valido piÃ¹ vicino
                    let bestMatch = validGrades.reduce((prev, curr) => {
                        return (Math.abs(curr.val - targetVal) < Math.abs(prev.val - targetVal) ? curr : prev);
                    });
                    
                    // Correzione ultimo step: deve essere ALMENO quanto serve per la somma
                    if (i === N - 1 && bestMatch.val < pointsRemaining) {
                         bestMatch = validGrades.find(g => g.val >= pointsRemaining) || bestMatch;
                    }
                    
                    // Limiti 1-10
                    if(bestMatch.val > 10) bestMatch = {val:10, display:"10", impossible:true};
                    
                    path.push(bestMatch);
                    pointsRemaining -= bestMatch.val;
                }
                
                const realAvgNeeded = path.reduce((a,b)=>a+b.val,0) / N;
                let avgDisplayObj = validGrades.reduce((prev, curr) =>
                     (Math.abs(curr.val - realAvgNeeded) < Math.abs(prev.val - realAvgNeeded) ? curr : prev)
                );

                return {
                    neededAvg: avgDisplayObj.display,
                    numericVal: realAvgNeeded,
                    difficulty: this.evaluateDifficulty(Math.max(...path.map(p=>p.val))),
                    path: path,
                    message: this.generateAdvice(realAvgNeeded, N, avgDisplayObj.display, false)
                };
            }

            generateValidGradeScale() {
                let scale = [];
                for (let i = 1; i <= 10; i++) {
                    scale.push({ val: i, display: i.toString() });
                    if (i === 10) break;
                    scale.push({ val: i + this.step, display: i + "+" });
                    if (Math.abs(this.step - 0.5) > 0.01) {
                         scale.push({ val: i + 0.5, display: i + "Â½" });
                    }
                    scale.push({ val: (i + 1) - this.step, display: (i + 1) + "-" });
                }
                return scale.sort((a, b) => a.val - b.val);
            }

            evaluateDifficulty(val) {
                if (val > 10) return 'impossible';
                if (val > this.stats.max + 0.5) return 'extreme';
                if (val > this.stats.max) return 'hard';
                if (val > this.stats.avg) return 'medium';
                return 'easy';
            }

            generateAdvice(val, N, displayVal, isImpossible) {
                const diff = isImpossible ? 'impossible' : this.evaluateDifficulty(val);
                if (diff === 'impossible') return { icon: "fa-skull-crossbones", color: "var(--danger)", title: "Impossibile", text: `Serve una media del <strong>${displayVal}</strong>.` };
                if (diff === 'extreme') return { icon: "fa-fire", color: "#f97316", title: "Record Personale", text: `Devi superarti. Media necessaria: <strong>${displayVal}</strong>.` };
                if (diff === 'hard') return { icon: "fa-mountain", color: "var(--warning)", title: "Impegnativo", text: `Devi eguagliare i tuoi voti migliori (${displayVal}).` };
                if (diff === 'medium') return { icon: "fa-bolt", color: "#38bdf8", title: "Fattibile", text: `Obiettivo media <strong>${displayVal}</strong>.` };
                return { icon: "fa-check-circle", color: "var(--success)", title: "Tranquillo", text: `Ti basta media <strong>${displayVal}</strong>.` };
            }
        }

        /* --- FIREBASE CONFIG --- */
        const firebaseConfig = {
            apiKey: "AIzaSyCZ36t3Zi0D_A1q2MjjZp2V6d1Zb2adGzs",               authDomain: "mioregistro-668d3.firebaseapp.com",               projectId: "mioregistro-668d3",               storageBucket: "mioregistro-668d3.firebasestorage.app",               messagingSenderId: "114433976476",               appId: "1:114433976476:web:49c7628bf354783372a559",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = {};
        let userName = "Studente";
        let userPronoun = "m";
        let userGradeStep = 0.20; // DEFAULT
        let myChart = null;
        let detailChart = null;
        let isRegisterMode = false;
        let recoveryGradeCount = 2; // Default recovery count

        // VOTE SELECTOR STATE
        let voteState = {
            dash: { int: 6, mod: 'none' },
            det: { int: 6, mod: 'none' }
        };

        // --- EXPORT GLOBALS ---
        window.openSettings = () => { switchScreen('settings'); document.getElementById("myDropdown").classList.remove('show'); };
        window.closeSettings = () => switchScreen('app');
        window.toggleAuthMode = toggleAuthMode;
        window.handleAuth = handleAuth;
        window.loginWithGoogle = loginWithGoogle;
        window.saveSetup = saveSetup;
        window.toggleMenu = toggleMenu;
        window.logoutUser = () => signOut(auth);
        window.deleteMyAccount = deleteMyAccount;
        window.addGradeDB = addGradeDB;
        window.addSubjectDB = addSubjectDB;
        window.deleteGradeDB = deleteGradeDB;
        window.deleteCurrentSubject = deleteCurrentSubject;
        window.closeDetail = closeDetail;
        window.addGradeFromDetail = addGradeFromDetail;
        window.updateGradeStepDB = updateGradeStepDB;
        window.updateInt = updateInt;
        window.setMod = setMod;
        
        window.changeRecoveryCount = (val) => {
            recoveryGradeCount = parseInt(val);
            updateRecoveryStrategy();
        }

        // --- FUNZIONE RECUPERO AGGIORNATA CON PATH VISUALIZER ---
        window.updateRecoveryStrategy = function() {
            const subjectName = document.getElementById('detail-title').innerText;
            const grades = userData[subjectName] || [];
            
            let cS=0, cW=0;
            grades.forEach(g => {
                const i = (typeof g === 'number') ? {val:g, weight:100} : g;
                const w = (i.weight !== undefined ? i.weight : 100);
                cS += i.val * (w/100);
                cW += (w/100);
            });
            const avg = cW > 0 ? (cS / cW) : 0;

            const sb = document.getElementById('strategy-container');
            const isM = userPronoun === 'm'; const isF = userPronoun === 'f';
            const bravo = isM ? "Bravissimo" : (isF ? "Bravissima" : "Grande");

            let html = '';

            if (avg >= 6) {
                const minGrade = Math.ceil((6 * (cW + 1) - cS) * 10) / 10;
                sb.className = 'strategy-box strategy-safe';
                html = `<h3><i class="fa-solid fa-trophy"></i> ${bravo} ${userName}!</h3>
                        <p>Sei sopra la sufficienza. Per mantenere il 6 basta:</p>`;
                if(minGrade > 1) html += `<div class="safety-card" style="border-color:var(--success); color:var(--success)"><small>MINIMO SALVEZZA (Prossimo voto)</small><br><div class="safety-val">${minGrade}</div></div>`;
                else html += `<p><strong>Sei in una botte di ferro!</strong> Anche prendendo 1 resti sufficiente.</p>`;
            } else {
                sb.className = 'strategy-box';
                sb.style.borderColor = "var(--glass-border)";

                let optionsHtml = '';
                for(let i=1; i<=5; i++) {
                    optionsHtml += `<option value="${i}" ${recoveryGradeCount === i ? 'selected' : ''}>${i} Vot${i==1?'o':'i'}</option>`;
                }

                html = `<h3><i class="fa-solid fa-robot"></i> AI Strategist</h3>
                        <div style="margin-bottom:15px; padding:10px; border-radius:8px;">
                            <label style="font-size:0.9rem; color:inherit;">Pianifica recupero in:</label>
                            <select id="recovery-count" onchange="changeRecoveryCount(this.value)" style="margin-top:5px; border:none; border-bottom:1px solid white; color:inherit; background:transparent;">
                                ${optionsHtml}
                            </select>
                        </div>`;

                const ai = new RecoveryAI(grades, userGradeStep);
                const plan = ai.calculatePath(6.0, recoveryGradeCount);
                const advice = plan.message;

                // CARD PRINCIPALE
                html += `
                <div style="border: 1px solid ${advice.color}; background: linear-gradient(135deg, ${advice.color}11, transparent); padding: 20px; border-radius: 12px; text-align: center; margin-top: 10px;">
                    <div style="font-size: 2.5rem; color: ${advice.color}; margin-bottom: 10px;">
                        <i class="fa-solid ${advice.icon}"></i>
                    </div>
                    <h4 style="margin: 0; color: ${advice.color}; text-transform: uppercase; letter-spacing: 1px;">${advice.title}</h4>
                    
                    <div style="font-size: 3rem; font-weight: 700; margin: 10px 0; color: var(--text-main);">
                        ${plan.neededAvg}
                    </div>
                    <small style="opacity: 0.7; display: block; margin-bottom: 15px;">Media necessaria</small>
                    
                    <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; font-size: 0.95rem; line-height: 1.5;">
                        ${advice.text}
                    </div>
                </div>
                `;

                // VISUALIZZAZIONE "PERCORSO" (Se ci sono piÃ¹ voti)
                if (plan.path.length > 1) {
                    html += `<div class="path-container"><div class="path-steps">`;
                    plan.path.forEach((step, idx) => {
                        let stepClass = 'step-easy';
                        if (step.val > 8) stepClass = 'step-extreme';
                        else if (step.val > 6.5) stepClass = 'step-hard';
                        
                        if (idx === plan.path.length - 1) stepClass = 'step-easy';
                        
                        // ICONA DINAMICA
                        let iconClass = 'fa-shoe-prints'; // Default Inizio
                        if (idx === plan.path.length - 1) iconClass = 'fa-flag-checkered'; // Fine
                        else if (idx > 0) iconClass = 'fa-arrow-trend-up'; // Middle

                        html += `
                            <div class="path-step-card ${stepClass}">
                                <i class="fa-solid ${iconClass} path-icon"></i>
                                <span class="path-step-val">${step.display}</span>
                            </div>
                        `;
                        if (idx < plan.path.length - 1) {
                            html += `<i class="fa-solid fa-arrow-right path-arrow"></i>`;
                        }
                    });
                    html += `</div><small style="opacity:0.6; font-size:0.8rem; margin-top:5px;">Percorso consigliato</small></div>`;
                }

                if(plan.difficulty !== 'easy' && plan.difficulty !== 'impossible') {
                     html += `<div style="margin-top:10px; font-size:0.8rem; text-align:center; opacity:0.6;">
                        Tuo Max Storico: ${ai.stats.max} | Tuo Trend: ${ai.stats.trend === 'rising' ? 'â†— In salita' : (ai.stats.trend==='falling'?'â†˜ In discesa':'âž¡ Stabile')}
                     </div>`;
                }
            }

            sb.innerHTML = html;
        };

        window.handleCookieConsent = (accepted) => {
            document.getElementById('cookie-banner').style.display = 'none';
            if (accepted) {
                localStorage.setItem('cookieConsent', 'true');
                const isLight = document.body.classList.contains('light-mode');
                localStorage.setItem('theme', isLight ? 'light' : 'dark');
            } else {
                localStorage.removeItem('cookieConsent');
                localStorage.removeItem('theme');
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const consent = localStorage.getItem('cookieConsent');
            if (!consent) {
                setTimeout(() => document.getElementById('cookie-banner').style.display = 'block', 1000);
            }
        });

        async function handleSocialLogin(provider) {
            toggleLoader(true);
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const userRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userRef);

                if (!docSnap.exists()) {
                    const defaultSubjects = { "Matematica": [], "Italiano": [], "Inglese": [], "Storia": [], "Scienze": [], "Motoria": [] };
                    await setDoc(userRef, {
                        username: user.displayName.split(' ')[0] || "Studente",
                        pronoun: null,
                        gradeStep: 0.20,
                        subjects: defaultSubjects
                    });
                }
            } catch (error) { showError("Errore Social: " + error.message); toggleLoader(false); }
        }

        async function loginWithGoogle() { await handleSocialLogin(new GoogleAuthProvider()); }

        async function saveSetup() {
            const chosen = document.getElementById('setup-pronoun').value;
            await updateDoc(doc(db, "users", currentUser.uid), { pronoun: chosen });
            document.getElementById('setup-modal').style.display = 'none';
        }

        // --- NEW VOTE LOGIC (LIMIT FIX & RESET) ---
        function updateInt(ctx, change) {
            let newVal = voteState[ctx].int + change;
            if (newVal < 1) newVal = 1;
            if (newVal > 10) newVal = 10;

            if (newVal === 10 && (voteState[ctx].mod === 'plus' || voteState[ctx].mod === 'half')) {
                setMod(ctx, 'none');
            }
            if (newVal === 1 && voteState[ctx].mod === 'minus') {
                setMod(ctx, 'none');
            }

            voteState[ctx].int = newVal;
            document.getElementById(`${ctx}-vote-val`).innerText = newVal;
            updateModButtons(ctx);
        }

        function setMod(ctx, mod) {
            const currentInt = voteState[ctx].int;
            if (currentInt === 10 && (mod === 'plus' || mod === 'half')) return;
            if (currentInt === 1 && mod === 'minus') return;

            voteState[ctx].mod = mod;
            updateModButtons(ctx);
        }

        function updateModButtons(ctx) {
            const mods = ['none', 'plus', 'minus', 'half'];
            const currentInt = voteState[ctx].int;
            
            mods.forEach(m => {
                const btn = document.getElementById(`${ctx}-mod-${m}`);
                btn.classList.remove('active');
                btn.disabled = false;

                if (currentInt === 10 && (m === 'plus' || m === 'half')) btn.disabled = true;
                if (currentInt === 1 && m === 'minus') btn.disabled = true;

                if (voteState[ctx].mod === m) btn.classList.add('active');
            });
        }

        function calculateVoteValue(ctx) {
            const v = voteState[ctx];
            let num = v.int;
            let display = v.int.toString();

            if (v.mod === 'plus') {
                num += userGradeStep;
                display += "+";
            } else if (v.mod === 'minus') {
                num -= userGradeStep;
                display += "-";
            } else if (v.mod === 'half') {
                num += 0.5;
                display += "Â½";
            }
            return { numeric: num, display: display };
        }

        // --- UPDATE STEP IN DB ---
        async function updateGradeStepDB() {
            const val = parseFloat(document.getElementById('grade-step-input').value);
            if(isNaN(val) || val < 0) return alert("Valore non valido");
            userGradeStep = val;
            if(currentUser) {
                await updateDoc(doc(db, "users", currentUser.uid), { gradeStep: val });
            }
        }

        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            const title = document.getElementById('auth-title');
            const btn = document.getElementById('auth-btn');
            const link = document.querySelector('.auth-switch');
            const nameField = document.getElementById('register-name-field');

            if(isRegisterMode) {
                title.innerText = "Inizia il tuo percorso";
                btn.innerText = "Crea Account";
                link.innerText = "Hai giÃ  un account? Accedi";
                nameField.classList.add('show-name-field');
            } else {
                title.innerText = "Accedi al tuo account";
                btn.innerText = "Accedi";
                link.innerText = "Non hai un account? Registrati";
                nameField.classList.remove('show-name-field');
            }
        }

        async function handleAuth() {
            const email = document.getElementById('email-input').value;
            const pass = document.getElementById('password-input').value;
            if(!email || !pass) return showError("Compila campi");
            toggleLoader(true);
            try {
                if(isRegisterMode) {
                    const name = document.getElementById('name-input').value.trim();
                    if(!name) throw new Error("Inserisci il tuo nome!");
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    const defaultSubjects = { "Matematica": [], "Italiano": [], "Inglese": [], "Storia": [], "Scienze": [], "Motoria": [] };
                    await setDoc(doc(db, "users", cred.user.uid), { username: name, pronoun: null, gradeStep: 0.20, subjects: defaultSubjects });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch(err) { showError(err.message); toggleLoader(false); }
        }

        function toggleMenu() { document.getElementById("myDropdown").classList.toggle("show"); }
        window.onclick = function(e) { if (!e.target.matches('.menu-btn') && !e.target.matches('.menu-btn *')) { document.getElementById("myDropdown").classList.remove('show'); } }
        async function deleteMyAccount() {
            if(!confirm("Sicuro di voler cancellare?")) return;
            try { await deleteDoc(doc(db, "users", currentUser.uid)); await deleteUser(currentUser); } catch(e){ alert("Rifai login per cancellare"); signOut(auth); }
        }

        onAuthStateChanged(auth, (user) => {
            toggleLoader(false);
            if (user) {
                currentUser = user;
                switchScreen('app');
                listenToData();
            } else { switchScreen('login'); }
        });

        function listenToData() {
            onSnapshot(doc(db, "users", currentUser.uid), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    userData = data.subjects || {};
                    userName = data.username || "Studente";
                    
                    userGradeStep = data.gradeStep !== undefined ? data.gradeStep : 0.20;
                    document.getElementById('grade-step-input').value = parseFloat(userGradeStep).toFixed(2);

                    const localTheme = localStorage.getItem('theme');
                    const savedTheme = localTheme || data.theme || 'dark';
                    applyTheme(savedTheme);

                    if (!data.pronoun) {
                        document.getElementById('setup-modal').style.display = 'flex';
                        userPronoun = 'n';
                    } else {
                        document.getElementById('setup-modal').style.display = 'none';
                        userPronoun = data.pronoun;
                    }

                    document.getElementById('display-name').innerText = userName;
                    updateUI(userData);
                    
                    const title = document.getElementById('detail-title').innerText;
                    if(document.getElementById('detail-screen').style.display === 'flex' && userData[title]) {
                        renderDetail(title);
                    }
                }
            });
        }

        async function addSubjectDB() {
            const name = document.getElementById('new-subject-name').value.trim();
            if(!name || userData[name]) return;
            userData[name] = [];
            await updateDoc(doc(db,"users",currentUser.uid), {subjects: userData});
            document.getElementById('new-subject-name').value = '';
        }
        
        async function addGradeDB() {
            const s = document.getElementById('input-subject').value;
            const w = parseFloat(document.getElementById('input-weight').value);
            
            if(!s) return alert("Seleziona una materia");
            if (isNaN(w) || w < 0 || w > 100) return alert("Peso 0-100%");
            
            const parsed = calculateVoteValue('dash');
            
            userData[s].push({ val: parsed.numeric, display: parsed.display, weight: w, id: Date.now() });
            await updateDoc(doc(db,"users",currentUser.uid), {subjects: userData});
            
            voteState['dash'].int = 6;
            document.getElementById('dash-vote-val').innerText = '6';
            setMod('dash', 'none');
            updateModButtons('dash');
            document.getElementById('input-weight').value = '100';
        }

        async function addGradeFromDetail() {
            const subject = document.getElementById('detail-title').innerText;
            const w = parseFloat(document.getElementById('detail-input-weight').value);

            if (isNaN(w) || w < 0 || w > 100) return alert("Peso 0-100%");
            
            const parsed = calculateVoteValue('det');

            userData[subject].push({ val: parsed.numeric, display: parsed.display, weight: w, id: Date.now() });
            await updateDoc(doc(db, "users", currentUser.uid), { subjects: userData });
            
            voteState['det'].int = 6;
            document.getElementById('det-vote-val').innerText = '6';
            setMod('det', 'none');
            updateModButtons('det');
            document.getElementById('detail-input-weight').value = '100';
        }

        async function deleteGradeDB(s, id) { if(confirm("Eliminare?")) { userData[s] = userData[s].filter(g => (g.id||g)!=id); await updateDoc(doc(db,"users",currentUser.uid), {subjects:userData}); } }
        async function deleteCurrentSubject() { const n = document.getElementById('detail-title').innerText; if(confirm("Eliminare "+n+"?")) { delete userData[n]; await updateDoc(doc(db,"users",currentUser.uid), {subjects:userData}); closeDetail(); } }

        function getGradeInfo(g) {
            if (typeof g === 'number') return { val: g, display: g, weight: 100, id: g };
            return { val: g.val, display: g.display || g.val, weight: (g.weight !== undefined ? g.weight : 100), id: g.id };
        }
        function calculateWeightedAvg(grades) { if (!grades.length) return 0; let s=0, tw=0; grades.forEach(g => { const i=getGradeInfo(g); s+=i.val*(i.weight/100); tw+=(i.weight/100); }); return tw===0?0:(s/tw); }
        
        function switchScreen(name) {
            ['login','app','detail','settings'].forEach(id => document.getElementById(id+'-screen').style.display = 'none');
            document.getElementById(name+'-screen').style.display = 'flex';
        }
        window.openDetail = (name) => { switchScreen('detail'); renderDetail(name); };
        function closeDetail() { switchScreen('app'); }

        function updateUI(subjects) {
            const cont = document.getElementById('subjects-container');
            const sel = document.getElementById('input-subject');
            cont.innerHTML = '';
            sel.innerHTML = '<option value="">Seleziona...</option>';
            
            let gs=0, gc=0, gi=0;
            const l=[], d=[];

            const sortedSubjects = Object.entries(subjects).sort((a, b) => a[0].localeCompare(b[0]));

            for (const [n, g] of sortedSubjects) {
                const opt = document.createElement('option'); opt.value = n; opt.innerText = n; sel.appendChild(opt);
                const avg = calculateWeightedAvg(g);
                if(g.length) { gs+=avg; gc++; gi+=g.length; }
                l.push(n);
                d.push(avg);
                const div = document.createElement('div'); div.className = 'subject-card'; div.onclick = () => openDetail(n);
                div.innerHTML = `<div><strong>${n}</strong><br><small style="color:var(--text-muted)">${g.length} voti</small></div><div style="font-size:1.5rem; color:${avg>=6?'var(--success)':'var(--danger)'}">${avg>0?avg.toFixed(1):'-'}</div>`;
                cont.appendChild(div);
            }

            let gAvg = gc>0 ? (gs/gc).toFixed(2) : 0;
            document.getElementById('global-average').innerText = gAvg;
            document.getElementById('count-subjects').innerText = gc;
            document.getElementById('count-grades').innerText = gi;
            document.getElementById('coach-message').innerText = "";
            updateMentalCoach(gAvg);

            if(myChart) myChart.destroy();

            const isLight = document.body.classList.contains('light-mode');
            const gridColor = isLight ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
            const textColor = isLight ? '#1e293b' : '#f8fafc';
            const backdrop = isLight ? 'rgba(255, 255, 255, 0.6)' : 'transparent';
            const pointColor = isLight ? '#6366f1' : '#fff';

            myChart = new Chart(document.getElementById('gradeChart'), {
                type: 'radar',
                data: {
                    labels: l,
                    datasets: [{
                        label: 'Media',
                        data: d,
                        fill: true,
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        borderColor: '#6366f1',
                        pointBackgroundColor: pointColor,
                        pointHoverBorderColor: '#6366f1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        r: {
                            min: 0, max: 10,
                            angleLines: { color: gridColor },
                            grid: { color: gridColor },
                            pointLabels: {
                                color: textColor,
                                font: {size: 12, weight: 'bold'},
                                backdropColor: backdrop,
                                borderRadius: 4
                            },
                            ticks: {
                                backdropColor: 'transparent',
                                color: isLight ? '#64748b' : '#94a3b8',
                                stepSize: 1,
                                callback: v => (v===6||v===10)?v:''
                            }
                        }
                    }
                }
            });
        }

        function updateMentalCoach(avg) {
            const isM = userPronoun === 'm';
            const isF = userPronoun === 'f';
            const o_a = isM ? 'o' : (isF ? 'a' : '*');
            const bravo = isM ? 'bravissimo' : (isF ? 'bravissima' : 'una forza');
            const pronto = isM ? 'pronto' : (isF ? 'pronta' : 'pront*');
            const carico = isM ? 'carico' : (isF ? 'carica' : 'a mille');
            const concentrato = isM ? 'concentrato' : (isF ? 'concentrata' : 'sul pezzo');
            const determinato = isM ? 'determinato' : (isF ? 'determinata' : 'con grinta');
            const campione = isM ? 'campione' : (isF ? 'campionessa' : 'star');

            const phrases = {
                welcome: [`Ciao ${userName}, benvenut${o_a}!`, `Tutto ${pronto} per spaccare?`, `Facciamo vedere di che pasta sei fatt${o_a}!`, `Sei ${carico}?`, `Andiamo!`],
                excellent: [`Wow ${userName}, sei ${bravo}!`, `Livello leggendario! ðŸš€`, `Non ti ferma piÃ¹ nessuno!`, `Che media, sei un vero ${campione}.`, `Impeccabile.`],
                good: [`Bene ${userName}, stai andando alla grande.`, `Avanti tutta! ðŸ‘`, `Ottima gestione.`, `Solido come una roccia.`, `Sei decisamente ${determinato}.`],
                borderline: [`Occhio ${userName}, siamo sul filo.`, `Resta ${concentrato}, manca poco per risalire.`, `Non mollare ora!`, `Serve l'ultimo sprint!`, `Stringi i denti.`],
                critical: [`Momento no? Capita.`, `Testa alta: recuperiamo tutto!`, `Non Ã¨ finita.`, `Resetta e riparti.`, `Trasforma la rabbia in energia.`]
            };
            let list;
            if (avg == 0) list = phrases.welcome;
            else if (avg >= 8) list = phrases.excellent;
            else if (avg >= 6) list = phrases.good;
            else if (avg >= 5) list = phrases.borderline;
            else list = phrases.critical;
            document.getElementById('coach-message').innerHTML = list[Math.floor(Math.random() * list.length)];
        }

        function renderDetail(name) {
            const grades = userData[name] || [];
            document.getElementById('detail-title').innerText = name;
            let cS=0, cW=0, maxG=0;
            grades.forEach(g => {
                const i=getGradeInfo(g);
                cS+=i.val*(i.weight/100);
                cW+=(i.weight/100);
                if(i.val > maxG) maxG = i.val;
            });
            if(maxG === 0) maxG = 6;

            const avg = cW>0 ? (cS/cW) : 0;
            document.getElementById('detail-average').innerText = avg.toFixed(2);
            document.getElementById('detail-average').style.color = avg>=6?'var(--success)':'var(--danger)';
            
            const ld = document.getElementById('detail-grades-list'); ld.innerHTML = '';
            grades.forEach(g => {
                const i=getGradeInfo(g);
                ld.innerHTML += `<div class="grade-item-detailed"><div class="grade-val ${i.val>=6?'grade-good':'grade-bad'}">${i.display}</div><div style="flex-grow:1"><span style="font-size:0.8rem;opacity:0.7">Voto:${i.val.toFixed(2)}</span><span class="grade-weight">Peso:${i.weight}%</span></div><i class="fa-solid fa-trash delete-single-btn" onclick="deleteGradeDB('${name}', ${i.id})"></i></div>`;
            });

            updateRecoveryStrategy();

            if(detailChart) detailChart.destroy();
            let ps=0, pw=0;

            const isLight = document.body.classList.contains('light-mode');
            const gridColor = isLight ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';
            const textColor = isLight ? '#1e293b' : '#f8fafc';

            detailChart = new Chart(document.getElementById('detailChart'), {
                type: 'line',
                data: {
                    labels: grades.map((_,i)=>`Voto ${i+1}`),
                    datasets: [{
                        label: 'Voti',
                        data: grades.map(g => getGradeInfo(g).val),
                        borderColor: '#6366f1',
                        tension: 0.3,
                        fill: true,
                        backgroundColor: 'rgba(99,102,241,0.2)'
                    }]
                },
                options: {
                    responsive:true,
                    maintainAspectRatio:false,
                    plugins:{legend:{display:false}},
                    scales:{
                        y:{
                            min:1, max:10,
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: textColor }
                        }
                    }
                }
            });
        }

        function toggleLoader(s){document.getElementById('loader').style.display=s?'block':'none'}
        function showError(m){document.getElementById('error-msg').innerText=m}
        
        window.toggleThemeDB = async function() {
            const isDark = document.getElementById('theme-switch').checked;
            const newTheme = isDark ? 'dark' : 'light';
            
            applyTheme(newTheme);

            if (localStorage.getItem('cookieConsent')) {
                localStorage.setItem('theme', newTheme);
            }

            if (userData) {
                updateUI(userData);
                
                const detailScreen = document.getElementById('detail-screen');
                if (detailScreen.style.display === 'flex') {
                    const title = document.getElementById('detail-title').innerText;
                    renderDetail(title);
                }
            }

            if(currentUser) {
                await updateDoc(doc(db, "users", currentUser.uid), { theme: newTheme });
            }
        };

        function applyTheme(theme) {
            const body = document.body;
            const switchEl = document.getElementById('theme-switch');
            if (theme === 'light') {
                body.classList.add('light-mode');
                if(switchEl) switchEl.checked = false;
            } else {
                body.classList.remove('light-mode');
                if(switchEl) switchEl.checked = true;
            }
        }
    </script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('App registrata per il download', reg))
            .catch(err => console.log('Errore registrazione app:', err));
        });
      }
    </script>
</body>
</html>
